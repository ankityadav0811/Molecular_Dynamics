# ---------------------------------------------------------
# LAMMPS Input Script: Equilibrium Volume Calculation (Al)
# Temperature: 600K | Potential: MEAM | Ensemble: NPT
# ---------------------------------------------------------

clear
echo            none
suffix          omp

# --- Variables ---
variable time_step      equal   0.001
variable tdamp          equal   "v_time_step*100"
variable pdamp          equal   "v_time_step*1000"
variable ytemp          equal   600.0
variable time_50ps      equal   50000

units           metal
atom_style      atomic
boundary        p p p
variable a0     equal 4.04999918095267

# --- Geometry ---
lattice         fcc ${a0}
region          box block 0 8 0 8 0 8
create_box      1 box
create_atoms    1 box

include         potential.mod
mass            1 26.9815  # Al

# --- Equilibrium ---
minimize        0.0 1.0e-6 10000 100000
velocity        all create ${ytemp} 376847 mom yes rot yes dist gaussian loop all
timestep        ${time_step}

# --- Computes & Variables ---
compute         eng_per_atom all pe/atom
compute         ke_per_atom all ke/atom
variable        myvol equal vol
variable        num_atoms equal count(all)

# --- Fixes ---
# NPT with anisotropic pressure control at 0.0 bar
fix             2 all npt temp ${ytemp} ${ytemp} ${tdamp} drag 1.0 pchain 8 aniso 0.0 0.0 ${pdamp}

# Averaging fix: Synchronized with thermo 2000
fix             avg_vol all ave/time 1 2000 2000 v_myvol ave running

# --- Output Settings ---
thermo          2000
thermo_style    custom step temp pe press vol f_avg_vol lx ly cpuremain
run             ${time_50ps}

# --- Final Volume Extractions ---

# 1. Instantaneous (Last Step)
variable        box_volume equal vol
variable        per_atom_volume equal "v_box_volume / v_num_atoms"

# 2. Averaged (Over the full run)
variable        avg_vol_per_atom equal "f_avg_vol / v_num_atoms"

print "---------------------------------------------------------"
print "      VOLUME COMPARISON AT ${ytemp} K"
print "---------------------------------------------------------"
print " INSTANTANEOUS (Step 50k):"
print "   - Box Volume:          ${box_volume} Ang^3"
print "   - Vol/Atom:            ${per_atom_volume} Ang^3/atom"
print ""
print " AVERAGED (Cumulative):"
print "   - Box Volume:          ${f_avg_vol} Ang^3"
print "   - Vol/Atom:            ${avg_vol_per_atom} Ang^3/atom"
print "---------------------------------------------------------"

unfix 2
unfix avg_vol
